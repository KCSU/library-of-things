{% extends "base.html" %}

{% block preamble %}
<div 
  id="mobile-navbar" 
  class="fixed top-0 left-0 right-0 z-25 md:hidden w-full p-2 border-b border-[oklch(1_0_0/0.1)] bg-[oklch(.205_0_0)] flex items-center justify-between" 
  style="transition: opacity 300ms ease-in-out;"
>
  <a href="/" class="flex items-center" aria-label="KCSU Home">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="KCSU Logo" class="h-6 pl-3" />
  </a>
  <button 
    type="button" 
    onclick="document.dispatchEvent(new CustomEvent('basecoat:sidebar'))"
    aria-label="Toggle menu"
    class="ml-auto p-2"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="4" x2="20" y1="12" y2="12"/>
      <line x1="4" x2="20" y1="6" y2="6"/>
      <line x1="4" x2="20" y1="18" y2="18"/>
    </svg>
  </button>
</div>

<div 
  id="sidebar-overlay" 
  class="md:hidden fixed inset-0 z-30 bg-black/50 opacity-0 pointer-events-none overscroll-none touch-none" 
  style="transition: opacity 300ms ease-in-out;"
  onclick="document.dispatchEvent(new CustomEvent('basecoat:sidebar', { detail: { action: 'close' } }))"
  ontouchmove="event.preventDefault()"
  onwheel="event.preventDefault()"
></div>

<script>
  $(document).ready(function() {
    const $sidebar = $('.sidebar');
    const $navbar = $('#mobile-navbar');
    const $overlay = $('#sidebar-overlay');
    
    const observer = new MutationObserver(function(mutations) {
      if (window.innerWidth >= 768) return; // md breakpoint

      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'aria-hidden') {
          const isHidden = $sidebar.attr('aria-hidden') === 'true';
          
          if (isHidden) {
            $overlay.css({ opacity: '0', pointerEvents: 'none' });
            $('body').css('overflow', '');
          } else {
            $overlay.css({ opacity: '1', pointerEvents: 'auto' });
            $('body').css('overflow', 'hidden');
          }
        }
      });
    });
    
    observer.observe($sidebar[0], { attributes: true });
  });
</script>

<aside 
  class="sidebar max-md:fixed max-md:inset-0 bg-transparent! max-md:aria-hidden:translate-x-[-200%] max-md:transition-transform max-md:duration-300 max-md:bg-[oklch(0.205_0_0)]" 
  data-side="left" 
  aria-hidden="false"
>
  <nav aria-label="Sidebar navigation" class="relative z-10">
    <header>
      <a href="/" class="btn-ghost p-2 h-12 w-full justify-start">
        <div
          class="bg-sidebar-primary text-sidebar-primary-foreground flex aspect-square size-8 items-center justify-center rounded-lg">
          <img class="rounded-sm" src="{{ url_for('static', filename='images/logo.jpg') }}">
        </div>
        <div class="grid flex-1 text-left text-sm leading-tight">
          <span class="truncate font-medium">Library of Things</span>
          <span class="truncate text-xs">v0.2.4</span>
        </div>
      </a>
    </header>
    <section class="scrollbar">
      <div role="group">
        <h3>Categories</h3>
        <ul class="">
          <li>
            <a href="/?category=clothing" class="{% if category == 'clothing' %}{% else %}bg-inherit! font-normal!{% endif %}">
              <span class="icon" data-icon="category/clothing"></span>
              <span>Clothing</span>
            </a>
          </li>
          <li>
            <a href="/?category=electronics" class="{% if category == 'electronics' %}{% else %}bg-inherit! font-normal!{% endif %}">
              <span class="icon" data-icon="category/electronics"></span>
              <span>Electronics</span>
            </a>
          </li>
          <li>
            <a href="/?category=furniture" class="{% if category == 'furniture' %}{% else %}bg-inherit! font-normal!{% endif %}">
              <span class="icon" data-icon="category/furniture"></span>
              <span>Furniture</span>
            </a>
          </li>
          <li>
            <a href="/?category=kitchenware" class="{% if category == 'kitchenware' %}{% else %}bg-inherit! font-normal!{% endif %}">
              <span class="icon" data-icon="category/kitchenware"></span>
              <span>Kitchenware</span>
            </a>
          </li>
          <li>
            <a href="/?category=sports" class="{% if category == 'sports' %}{% else %}bg-inherit! font-normal!{% endif %}">
              <span class="icon" data-icon="category/sports"></span>
              <span>Sports</span>
            </a>
          </li>
          <li>
            <a href="/?category=others" class="{% if category == 'others' %}{% else %}bg-inherit! font-normal!{% endif %}">
              <span class="icon" data-icon="category/others"></span>
              <span>Others</span>
            </a>
          </li>
        </ul>
      </div>
      {% if user.is_admin %}
      <div role="group">
        <h3>Administrator</h3>
        <ul>
          <li>
            <a href="/admin/site-manual">
              <span class="icon" data-icon="question-mark"></span>
              <span>Site Manual</span>
            </a>
          </li>
          <li>
            <a href="/admin/requests">
              <span class="icon" data-icon="request-add"></span>
              <span>Item Requests</span>
              {% if pending_requests_count > 0 %}
              <span style="background-color: #ff3f2d" class="ml-auto inline-flex items-center justify-center w-5 h-5 text-xs font-semibold text-white rounded-full">{{ pending_requests_count }}</span>
              {% endif %}
            </a>
          </li>
          <li>
            <a href="/admin/loans">
              <span class="icon" data-icon="on-loan"></span>
              <span>Active Loans</span>
            </a>
          </li>
          <li>
            <a href="/admin/inventory">
              <span class="icon" data-icon="edit"></span>
              <span>Manage Inventory</span>
            </a>
          </li>
          <li>
            <a href="/admin/list">
              <span class="icon" data-icon="shield"></span>
              <span>Administrator List</span>
            </a>
          </li>
          <li>
            <a href="/admin/directory">
              <span class="icon" data-icon="directory"></span>
              <span>User List</span>
            </a>
          </li>
          <li>
            <a href="/admin/settings">
              <span class="icon" data-icon="settings"></span>
              <span>Settings</span>
            </a>
          </li>
        </ul>
      </div>
      {% endif %}
    </section>
    <section class="flex-none! p-4">
      <div class="flex items-center gap-3 h-min">
        <img class="size-10 shrink-0 object-cover rounded-full" alt="{{ user.name }}" src="{{ user.picture }}">
        <div class="grid text-sm">
          <div>Logged in as <span class="font-semibold">{{ user.email | replace('@cam.ac.uk', '') }}</span></div>
          <a onclick="signOut()" href="/logout" class="text-sm text-gray-500 hover:underline hover:cursor-pointer">Log
            out</a>
        </div>
      </div>
    </section>
  </nav>
</aside>
{% endblock %}

{% block main %}
<div class="w-full p-8 max-md:pt-22">
  {% block content %}{% endblock %}
  <footer class="mt-10">
    <hr class="my-6 w-full" />
    <span class="text-sm text-gray-500">
      Â© 2025 <a href="https://kcsu.org.uk/" class="hover:underline">King's College Student Union</a>.
      All rights reserved.
    </span>
  </footer>
</div>
{% endblock %}